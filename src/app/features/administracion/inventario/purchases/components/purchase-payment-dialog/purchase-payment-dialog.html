<div class="payment-container">
    <h2 class="title">Finalizar Compra</h2>

    <div class="supplier-info" *ngIf="data.supplier">
        <div class="supplier-name">
            <mat-icon>person</mat-icon>
            <span>{{ data.supplier.name }}</span>
        </div>
        <div class="credit-details">
            <div class="credit-stat">
                <span class="label">Saldo:</span>
                <span class="value debt">{{ (data.supplier.balance || 0) | currency:'VES':'Bs.
                    ':settingsService.getDecimalFormat('total') }}</span>
            </div>
        </div>
    </div>

    <div class="totals-summary">
        <div class="total-row">
            <span>Subtotal</span>
            <span>{{ data.subtotal | currency:'VES':'Bs. ':settingsService.getDecimalFormat('total') }}</span>
        </div>
        <div class="total-row">
            <span>Impuestos</span>
            <span>{{ data.taxes | currency:'VES':'Bs. ':settingsService.getDecimalFormat('total') }}</span>
        </div>
        <div class="total-row main">
            <span>TOTAL COMPRA</span>
            <div>
                <div>{{ data.totalUSD | currency:'USD':'$ ':settingsService.getDecimalFormat('total') }}</div>
                <div>{{ data.total | currency:'VES':'Bs. ':settingsService.getDecimalFormat('total') }}</div>
            </div>
        </div>
    </div>

    <div class="currency-tabs">
        <button [class.active]="selectedCurrency === 'base'" (click)="setCurrency('base')">Bs. BOLÍVARES</button>
        <button [class.active]="selectedCurrency === 'alt'" (click)="setCurrency('alt')">$ DÓLARES (USD)</button>
    </div>

    <div style="margin-bottom: 8px; text-align: center;">
        <button mat-stroked-button color="primary" (click)="toggleMultiPayment()"
            style="height: 30px; line-height: 28px; font-size: 11px; border-radius: 6px; font-weight: 700; width: 100%;">
            <mat-icon style="font-size: 16px; width: 16px; height: 16px;">{{ isMultiPayment ? 'arrow_back' : 'layers'
                }}</mat-icon>
            {{ isMultiPayment ? 'VOLVER A PAGO SIMPLE' : 'ACTIVAR PAGO MIXTO' }}
        </button>
    </div>

    <!-- Single Payment Mode -->
    <ng-container *ngIf="!isMultiPayment">
        <div class="zen-details-container">
            <div class="zen-detail-row">
                <label>Monto Pagado</label>
                <input type="text" class="micro-detail-input"
                    style="font-size: 1.1rem; font-weight: 700; color: #3f51b5;" *ngIf="selectedCurrency === 'base'"
                    [(ngModel)]="receivedAmount" (ngModelChange)="calculateChange($event, 'base')" appMoneyInput
                    placeholder="0,00 Bs.">
                <input type="text" class="micro-detail-input"
                    style="font-size: 1.1rem; font-weight: 700; color: #3f51b5;" *ngIf="selectedCurrency === 'alt'"
                    [(ngModel)]="receivedAmountAlt" (ngModelChange)="calculateChange($event, 'alt')" appMoneyInput
                    placeholder="0,00 $">
            </div>

            <div *ngIf="requiresBank(selectedMethod)" style="margin-top: 6px;">
                <div class="zen-detail-row">
                    <label>Referencia</label>
                    <input type="text" class="micro-detail-input" [(ngModel)]="paymentDetails[selectedMethod].reference"
                        placeholder="N° Ref / Documento">
                </div>
                <div class="zen-detail-row">
                    <label>Banco</label>
                    <mat-select [(ngModel)]="selectedBankId" class="zen-mat-select micro-detail-input"
                        placeholder="Seleccione Banco...">
                        <mat-option value="">Ninguno</mat-option>
                        <mat-option *ngFor="let bank of getFilteredBanks(selectedMethod)" [value]="bank.id">
                            {{ bank.name }} ({{ bank.currency }})
                        </mat-option>
                    </mat-select>
                </div>
                <div class="zen-detail-row" *ngIf="selectedMethod === 'paper'">
                    <label>Teléfono/ID</label>
                    <input type="text" class="micro-detail-input" [(ngModel)]="paymentDetails['paper'].cedula"
                        placeholder="0412... / V-12...">
                </div>
                <div class="zen-detail-row" *ngIf="selectedMethod === 'transfer'">
                    <label>Cta. Destino</label>
                    <input type="text" class="micro-detail-input" [(ngModel)]="paymentDetails['transfer'].account"
                        placeholder="Últimos 4 dígitos">
                </div>
            </div>
        </div>

        <div class="methods-grid">
            <div class="method-btn" [class.active]="selectedMethod === 'cash'" (click)="selectedMethod = 'cash'">
                <mat-icon>payments</mat-icon>
                <span>Efectivo</span>
            </div>
            <div class="method-btn" [class.active]="selectedMethod === 'card'" (click)="selectedMethod = 'card'">
                <mat-icon>credit_card</mat-icon>
                <span>Tarjeta</span>
            </div>
            <div class="method-btn" [class.active]="selectedMethod === 'paper'" (click)="selectedMethod = 'paper'">
                <mat-icon>smartphone</mat-icon>
                <span>P. Móvil</span>
            </div>
            <div class="method-btn" [class.active]="selectedMethod === 'transfer'"
                (click)="selectedMethod = 'transfer'">
                <mat-icon>account_balance</mat-icon>
                <span>Transf.</span>
            </div>
            <div class="method-btn" [class.active]="selectedMethod === 'Credito'" (click)="selectedMethod = 'Credito'"
                [class.disabled]="!data.supplier">
                <mat-icon>request_quote</mat-icon>
                <span>Crédito</span>
            </div>
        </div>
    </ng-container>

    <!-- Multi Payment Mode (Mixed) -->
    <div *ngIf="isMultiPayment" class="multi-payment-list">
        <!-- Reusing the Sales Zen Mix Row Pattern -->
        <ng-container *ngFor="let m of ['cash', 'card', 'paper', 'transfer', 'Credito']">
            <div class="mixed-method-row" *ngIf="m !== 'Credito' || data.supplier">
                <div class="mixed-header">
                    <mat-icon>{{ m === 'cash' ? 'payments' : m === 'card' ? 'credit_card' : m === 'paper' ? 'smartphone'
                        : m === 'transfer' ? 'account_balance' : 'request_quote' }}</mat-icon>
                    <span>{{ m === 'cash' ? 'Efectivo' : m === 'card' ? 'Tarjeta' : m === 'paper' ? 'Pago Móvil' : m ===
                        'transfer' ? 'Transferencia' : 'A Crédito' }}</span>
                </div>
                <div style="display: flex; gap: 8px;">
                    <div class="micro-labeled-row" style="flex: 1;">
                        <div class="micro-label">Bs.</div>
                        <div class="micro-input-wrapper">
                            <input type="text" [(ngModel)]="payments[m]"
                                (ngModelChange)="updateMultiPayment(m, $event, 'base')" appMoneyInput
                                placeholder="0,00">
                        </div>
                    </div>
                    <div class="micro-labeled-row" style="flex: 1;">
                        <div class="micro-label">$</div>
                        <div class="micro-input-wrapper">
                            <input type="text" [(ngModel)]="paymentsAlt[m]"
                                (ngModelChange)="updateMultiPayment(m, $event, 'alt')" appMoneyInput placeholder="0,00">
                        </div>
                    </div>
                </div>

                <!-- Conditional Zen Details for Mixed Row -->
                <div class="zen-details-container" style="margin-top: 6px; padding: 4px 8px;"
                    *ngIf="(payments[m] > 0 || paymentsAlt[m] > 0) && requiresBank(m)">
                    <div class="zen-detail-row">
                        <label>Referencia</label>
                        <input type="text" class="micro-detail-input" [(ngModel)]="paymentDetails[m].reference"
                            placeholder="Ref #">
                    </div>
                    <div class="zen-detail-row">
                        <label>Banco</label>
                        <mat-select [(ngModel)]="paymentDetails[m].bank_id" class="zen-mat-select micro-detail-input"
                            placeholder="Sel. Banco">
                            <mat-option value="">Ninguno</mat-option>
                            <mat-option *ngFor="let bank of getFilteredBanks(m)" [value]="bank.id">{{ bank.name
                                }}</mat-option>
                        </mat-select>
                    </div>
                </div>
            </div>
        </ng-container>
    </div>

    <div class="change-display">
        <span class="change-label">{{ remaining > 0.05 ? 'Faltante' : 'Vuelto' }}</span>
        <div>
            <div [class.text-danger]="remaining > 0.05">{{ (remaining > 0.05 ? remainingAlt : changeAlt) |
                currency:'USD':'$ ':settingsService.getDecimalFormat('total') }}</div>
            <div class="change-value" [class.text-danger]="remaining > 0.05">{{ (remaining > 0.05 ? remaining : change)
                | currency:'VES':'Bs. ':settingsService.getDecimalFormat('total') }}</div>
        </div>
    </div>

    <div class="actions">
        <button mat-button class="btn-cancel" (click)="onCancel()">CANCELAR</button>
        <button mat-raised-button class="btn-confirm" (click)="onConfirm()" [disabled]="remaining > 0.05">
            PROCESAR COMPRA
        </button>
    </div>
</div>