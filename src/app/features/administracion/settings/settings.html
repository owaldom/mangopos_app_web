<div class="settings-container">
    <mat-card>
        <mat-card-header>
            <mat-card-title>Configuración General</mat-card-title>
            <mat-card-subtitle>Ajustes regionales y visuales de la aplicación</mat-card-subtitle>
        </mat-card-header>

        <mat-card-content *ngIf="!loading">
            <div class="settings-section">
                <h3>Decimales y Precisión</h3>
                <div class="grid-row">
                    <mat-form-field appearance="outline">
                        <mat-label>Decimales en Precios</mat-label>
                        <input matInput type="number" [(ngModel)]="settings.price_decimals" min="0" max="6">
                        <mat-hint>Ej: 2 -> 1,23 | 3 -> 1,234</mat-hint>
                    </mat-form-field>

                    <mat-form-field appearance="outline">
                        <mat-label>Decimales en Totales</mat-label>
                        <input matInput type="number" [(ngModel)]="settings.total_decimals" min="0" max="6">
                    </mat-form-field>

                    <mat-form-field appearance="outline">
                        <mat-label>Decimales en Cantidades</mat-label>
                        <input matInput type="number" [(ngModel)]="settings.quantity_decimals" min="0" max="6">
                    </mat-form-field>

                    <mat-form-field appearance="outline">
                        <mat-label>Decimales en Porcentaje</mat-label>
                        <input matInput type="number" [(ngModel)]="settings.percentage_decimals" min="0" max="6">
                        <mat-hint>Ej: 0 -> 10% | 2 -> 10,00%</mat-hint>
                    </mat-form-field>
                </div>
            </div>

            <div class="settings-section">
                <h3>Moneda y Empresa</h3>
                <div class="grid-row">
                    <mat-form-field appearance="outline">
                        <mat-label>Símbolo de Moneda</mat-label>
                        <input matInput [(ngModel)]="settings.currency_symbol" placeholder="Bs.">
                    </mat-form-field>

                    <mat-form-field appearance="outline">
                        <mat-label>Código de Moneda</mat-label>
                        <input matInput [(ngModel)]="settings.currency_code" placeholder="VES">
                    </mat-form-field>

                    <mat-form-field appearance="outline" class="full-width">
                        <mat-label>Nombre de la Empresa</mat-label>
                        <input matInput [(ngModel)]="settings.company_name">
                    </mat-form-field>

                    <mat-form-field appearance="outline" class="full-width">
                        <mat-label>Dirección</mat-label>
                        <textarea matInput [(ngModel)]="settings.company_address" rows="2"></textarea>
                    </mat-form-field>

                    <div class="toggle-container" style="margin-top: 10px;">
                        <mat-slide-toggle [(ngModel)]="settings.enable_pdf_ticket" color="primary">
                            Mostrar ticket PDF si falla impresora térmica
                        </mat-slide-toggle>
                        <mat-hint class="toggle-hint"
                            style="display: block; margin-top: 5px; font-size: 12px; color: #666;">
                            Si se activa, se mostrará el diálogo de impresión del navegador cuando la impresora térmica
                            no esté conectada.
                        </mat-hint>
                    </div>
                </div>
            </div>

            <div class="settings-section">
                <h3>Impuestos y Fiscalidad (IGTF)</h3>
                <div class="grid-row" style="align-items: center; gap: 40px;">
                    <div class="toggle-container">
                        <mat-slide-toggle [(ngModel)]="settings.igtf_enabled" color="warn">
                            Habilitar cobro de IGTF en pagos en Divisas
                        </mat-slide-toggle>
                    </div>

                    <mat-form-field appearance="outline" *ngIf="settings.igtf_enabled" style="width: 150px;">
                        <mat-label>Porcentaje IGTF (%)</mat-label>
                        <input matInput type="number" [(ngModel)]="settings.igtf_percentage" min="0" max="100">
                        <span matSuffix>%</span>
                    </mat-form-field>
                </div>
                <mat-hint class="toggle-hint" style="display: block; margin-top: 5px; font-size: 12px; color: #666;">
                    El IGTF se aplicará automáticamente sobre el monto recibido en moneda extranjera (USD).
                </mat-hint>
            </div>

            <div class="settings-section">
                <h3>Apariencia y POS</h3>
                <div class="grid-row">
                    <mat-form-field appearance="outline">
                        <mat-label>Diseño del Punto de Venta</mat-label>
                        <mat-select [(ngModel)]="settings.pos_layout">
                            <mat-option value="classic">Clásico (Tablas y Listas)</mat-option>
                            <mat-option value="modern">Moderno (Cuadrícula y Visual)</mat-option>
                        </mat-select>
                        <mat-hint>Cambia la apariencia de la pantalla de ventas</mat-hint>
                    </mat-form-field>

                    <mat-form-field appearance="outline" class="full-width">
                        <mat-label>Servidor de Impresión (Thermal)</mat-label>
                        <input matInput [(ngModel)]="settings.print_server_url" placeholder="http://localhost:3001/api">
                        <mat-hint>URL del servidor de impresión térmica (ej: http://localhost:3001/api)</mat-hint>
                    </mat-form-field>

                    <mat-form-field appearance="outline">
                        <mat-label>Tipo de Instalación</mat-label>
                        <mat-select [(ngModel)]="currInstallationType">
                            <mat-option value="factory">Instalación en Fábrica (Distribuidor)</mat-option>
                            <mat-option value="pos">Punto de Venta (Receptor)</mat-option>
                        </mat-select>
                        <mat-hint>Define qué funciones de distribución estarán disponibles</mat-hint>
                    </mat-form-field>

                    <mat-form-field appearance="outline" *ngIf="warehouses.length > 0">
                        <mat-label>Almacén Asociado</mat-label>
                        <mat-select [(ngModel)]="selectedWarehouseId">
                            <mat-option *ngFor="let w of warehouses" [value]="w.id">
                                {{ w.name }} ({{ w.type.toUpperCase() }})
                            </mat-option>
                        </mat-select>
                        <mat-hint>Almacén que usará este terminal para stock y catálogo</mat-hint>
                    </mat-form-field>
                </div>
            </div>

            <div class="settings-section currencies-section">
                <h3>Monedas y Tasas de Cambio (Basado en Bs.)</h3>
                <div class="currency-item" *ngFor="let curr of currencies">
                    <div class="curr-header">
                        <strong>{{ curr.code }}</strong> - {{ curr.name }}
                    </div>
                    <div class="grid-row">
                        <mat-form-field appearance="outline">
                            <mat-label>Nombre</mat-label>
                            <input matInput [(ngModel)]="curr.name">
                        </mat-form-field>

                        <mat-form-field appearance="outline">
                            <mat-label>Símbolo</mat-label>
                            <input matInput [(ngModel)]="curr.symbol">
                        </mat-form-field>

                        <mat-form-field appearance="outline">
                            <mat-label>Tasa de Cambio (1 {{curr.code}} = ? Bs.)</mat-label>
                            <input matInput type="text" [(ngModel)]="curr.exchange_rate" [disabled]="curr.is_base"
                                appMoneyInput decimalType="price">
                            <mat-hint *ngIf="curr.is_base">Moneda Base (Fija)</mat-hint>
                        </mat-form-field>

                        <button mat-stroked-button color="accent" (click)="saveCurrency(curr)">
                            ACTUALIZAR
                        </button>
                    </div>
                </div>
            </div>
        </mat-card-content>

        <mat-card-actions align="end">
            <button mat-flat-button color="primary" (click)="saveSettings()">
                <mat-icon>save</mat-icon>
                GUARDAR CAMBIOS
            </button>
        </mat-card-actions>
    </mat-card>
</div>