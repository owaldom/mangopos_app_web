<div class="dashboard-container">
    <header class="dashboard-header">
        <div class="header-content">
            <div class="header-text">
                <h1>Panel de Control</h1>
                <p>Análisis de gestión y resumen operativo</p>
            </div>
            <div class="header-actions">
                <span class="last-update">Última actualización: {{ today | date:'shortTime' }}</span>
                <button mat-icon-button (click)="loadDashboardData()" [disabled]="loading" matTooltip="Refrescar datos">
                    <mat-icon [class.spinning]="loading">refresh</mat-icon>
                </button>
            </div>
        </div>
    </header>

    <!-- Essential Stats Grid (Today) -->
    <div class="stats-grid">
        @for (stat of stats; track stat.label) {
        <mat-card class="stat-card">
            <mat-card-content>
                <div class="stat-icon" [style.background-color]="stat.color + '15'" [style.color]="stat.color">
                    <mat-icon>{{ stat.icon }}</mat-icon>
                </div>
                <div class="stat-info">
                    <span class="stat-label">{{ stat.label }}</span>
                    <h2 class="stat-value">{{ stat.value }}</h2>
                    <span class="stat-trend">{{ stat.trend }}</span>
                </div>
            </mat-card-content>
        </mat-card>
        }
    </div>

    <!-- Main Analytics Content -->
    <div class="analytics-grid" *ngIf="advancedStats">

        <!-- Sales Trend & Payment methods -->
        <mat-card class="span-2">
            <mat-card-header>
                <mat-card-title>Tendencia de Ventas (30 días)</mat-card-title>
                <mat-card-subtitle>Ingresos totales por día en Bolívares</mat-card-subtitle>
            </mat-card-header>
            <mat-card-content>
                <div class="chart-container-lg">
                    <canvas baseChart [data]="salesChartData" [options]="salesChartOptions" [type]="'line'">
                    </canvas>
                </div>
            </mat-card-content>
        </mat-card>

        <mat-card>
            <mat-card-header>
                <mat-card-title>Métodos de Pago</mat-card-title>
            </mat-card-header>
            <mat-card-content>
                <div class="chart-container">
                    <canvas baseChart [data]="paymentChartData" [options]="paymentChartOptions" [type]="'doughnut'">
                    </canvas>
                </div>
            </mat-card-content>
        </mat-card>

        <!-- Inventory & AR/AP -->
        <mat-card>
            <mat-card-header>
                <mat-card-title>Salud del Inventario</mat-card-title>
                <mat-card-subtitle>Distribución de existencias</mat-card-subtitle>
            </mat-card-header>
            <mat-card-content title="Valor Total: Bs. {{ advancedStats.inventory.totalValueBs | number:'1.2-2' }}">
                <div class="chart-container">
                    <canvas baseChart [data]="stockChartData" [options]="paymentChartOptions" [type]="'doughnut'">
                    </canvas>
                </div>
                <div class="total-value-overlay">
                    <small>Valor Total Estimado</small>
                    <strong>Bs. {{ advancedStats.inventory.totalValueBs | number:'1.0-0' }}</strong>
                </div>
            </mat-card-content>
        </mat-card>

        <!-- AR / AP Summary -->
        <mat-card class="balance-card">
            <mat-card-header>
                <mat-card-title>Cartera y Compromisos</mat-card-title>
            </mat-card-header>
            <mat-card-content>
                <div class="balance-item cxc">
                    <div class="balance-icon"><mat-icon>people_outline</mat-icon></div>
                    <div class="balance-details">
                        <label>Cuentas por Cobrar ({{ advancedStats.cxc.count }})</label>
                        <span class="value">Bs. {{ advancedStats.cxc.totalBs | number:'1.2-2' }}</span>
                    </div>
                </div>
                <mat-divider></mat-divider>
                <div class="balance-item cxp">
                    <div class="balance-icon"><mat-icon>local_shipping</mat-icon></div>
                    <div class="balance-details">
                        <label>Cuentas por Pagar ({{ advancedStats.cxp.count }})</label>
                        <span class="value">Bs. {{ advancedStats.cxp.totalBs | number:'1.2-2' }}</span>
                    </div>
                </div>
                <div class="balance-net" [class.negative]="advancedStats.cxc.totalBs < advancedStats.cxp.totalBs">
                    <label>Balance Neto de Cartera</label>
                    <strong>Bs. {{ (advancedStats.cxc.totalBs - advancedStats.cxp.totalBs) | number:'1.2-2' }}</strong>
                </div>
            </mat-card-content>
        </mat-card>

        <!-- Gastos -->
        <mat-card>
            <mat-card-header>
                <mat-card-title>Gastos por Categoría</mat-card-title>
                <mat-card-subtitle>Últimos 30 días</mat-card-subtitle>
            </mat-card-header>
            <mat-card-content>
                <div class="chart-container">
                    <canvas baseChart [data]="expensesChartData" [options]="expensesChartOptions" [type]="'bar'">
                    </canvas>
                </div>
            </mat-card-content>
        </mat-card>

        <!-- Top Productos -->
        <mat-card>
            <mat-card-header>
                <mat-card-title>Top 5 Productos más Vendidos</mat-card-title>
                <mat-card-subtitle>En los últimos 30 días (Unidades)</mat-card-subtitle>
            </mat-card-header>
            <mat-card-content>
                <div class="chart-container">
                    <canvas baseChart [data]="topProductsChartData" [options]="topProductsChartOptions" [type]="'bar'">
                    </canvas>
                </div>
            </mat-card-content>
        </mat-card>

        <!-- Bancos -->
        <mat-card class="span-2">
            <mat-card-header>
                <mat-card-title>Saldos Bancarios</mat-card-title>
                <button mat-button color="primary" (click)="navigateTo('/dashboard/bancos')">Ver cuentas</button>
            </mat-card-header>
            <mat-card-content>
                <div class="banks-grid">
                    <div class="bank-pill" *ngFor="let bank of advancedStats.banks">
                        <div class="bank-info">
                            <span class="name">{{ bank.name }}</span>
                            <span class="currency">{{ bank.currency }}</span>
                        </div>
                        <span class="balance">{{ bank.balance | number:'1.2-2' }}</span>
                    </div>
                    <div class="bank-pill total">
                        <div class="bank-info">
                            <span class="name">Total Gastos (30d)</span>
                        </div>
                        <span class="balance">Bs. {{ advancedStats.expenses.totalBs | number:'1.2-2' }}</span>
                    </div>
                </div>
            </mat-card-content>
        </mat-card>

        <!-- Recent Sales Table (Legacy support) -->
        <mat-card class="span-1">
            <mat-card-header>
                <mat-card-title>Últimos Tickets</mat-card-title>
                <button mat-button (click)="navigateTo('/dashboard/consultar-ventas')">Ver historial</button>
            </mat-card-header>
            <mat-card-content>
                <div class="mini-table">
                    <table mat-table [dataSource]="recentSales">
                        <ng-container matColumnDef="id">
                            <td mat-cell *matCellDef="let sale"> {{sale.id}} </td>
                        </ng-container>
                        <ng-container matColumnDef="customer">
                            <td mat-cell *matCellDef="let sale"> {{sale.customer}} </td>
                        </ng-container>
                        <ng-container matColumnDef="total">
                            <td mat-cell *matCellDef="let sale"> <strong>{{sale.total}}</strong> </td>
                        </ng-container>
                        <ng-container matColumnDef="time">
                            <td mat-cell *matCellDef="let sale"> {{sale.time | systemDate }} </td>
                        </ng-container>
                        <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
                    </table>
                </div>
                <app-shared-paginator [length]="recentSales.data.length" [pageSize]="50">
                </app-shared-paginator>
            </mat-card-content>
        </mat-card>

    </div>

    <!-- Quick Actions -->
    <div class="quick-actions-bar">
        <button class="action-chip" (click)="navigateTo('/dashboard/ventas/pos')">
            <mat-icon>point_of_sale</mat-icon> POS
        </button>
        <button class="action-chip" (click)="navigateTo('/dashboard/inventario/productos')">
            <mat-icon>inventory</mat-icon> Productos
        </button>
        <button class="action-chip" (click)="navigateTo('/dashboard/clientes')">
            <mat-icon>people</mat-icon> Clientes
        </button>
        <button class="action-chip" (click)="navigateTo('/dashboard/cierre-caja')">
            <mat-icon>lock</mat-icon> Cierre
        </button>
        <button class="action-chip" (click)="navigateTo('/dashboard/inventario/compras')">
            <mat-icon>shopping_basket</mat-icon> Compras
        </button>
    </div>
</div>