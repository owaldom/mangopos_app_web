<div class="container">
    <div class="header">
        <h1>Cambio Masivo de Precios</h1>
        <p class="subtitle">Actualice precios de múltiples productos simultáneamente</p>
    </div>

    <!-- Filtros -->
    <mat-card class="filter-card">
        <mat-card-header>
            <mat-card-title>Filtros de Búsqueda</mat-card-title>
        </mat-card-header>
        <mat-card-content>
            <div class="filter-form">
                <!-- Primera Fila -->
                <div class="filter-row">
                    <div class="barcode-container">
                        <mat-icon class="barcode-icon">qr_code_scanner</mat-icon>
                        <input #barcodeInput type="text" [(ngModel)]="filters.barcode" (keyup.enter)="searchProducts()"
                            placeholder="Escanea Código..." class="barcode-input">
                    </div>

                    <mat-form-field appearance="outline">
                        <mat-label>Precio Compra Mín</mat-label>
                        <input matInput type="text" [(ngModel)]="filters.priceBuyMin" placeholder="0.00" appMoneyInput
                            decimalType="price">
                        <span matPrefix>$&nbsp;</span>
                    </mat-form-field>

                    <mat-form-field appearance="outline">
                        <mat-label>Precio Compra Máx</mat-label>
                        <input matInput type="text" [(ngModel)]="filters.priceBuyMax" placeholder="0.00" appMoneyInput
                            decimalType="price">
                        <span matPrefix>$&nbsp;</span>
                    </mat-form-field>

                    <mat-form-field appearance="outline">
                        <mat-label>Precio Venta Mín</mat-label>
                        <input matInput type="text" [(ngModel)]="filters.priceSellMin" placeholder="0.00" appMoneyInput
                            decimalType="price">
                        <span matPrefix>$&nbsp;</span>
                    </mat-form-field>

                    <mat-form-field appearance="outline">
                        <mat-label>Precio Venta Máx</mat-label>
                        <input matInput type="text" [(ngModel)]="filters.priceSellMax" placeholder="0.00" appMoneyInput
                            decimalType="price">
                        <span matPrefix>$&nbsp;</span>
                    </mat-form-field>
                </div>

                <!-- Segunda Fila -->
                <div class="filter-row">
                    <mat-form-field appearance="outline">
                        <mat-label>Categoría</mat-label>
                        <mat-select [(ngModel)]="filters.categoryId">
                            <mat-option [value]="'all'">Todas</mat-option>
                            <mat-option *ngFor="let cat of categories" [value]="cat.id">
                                {{ cat.name }}
                            </mat-option>
                        </mat-select>
                    </mat-form-field>

                    <mat-form-field appearance="outline" class="flex-grow">
                        <mat-label>Nombre del Producto</mat-label>
                        <input matInput [(ngModel)]="filters.name" placeholder="Buscar por nombre">
                        <mat-icon matSuffix>search</mat-icon>
                    </mat-form-field>

                    <div class="button-group">
                        <button mat-button (click)="clearFilters()">
                            <mat-icon>clear</mat-icon> Limpiar
                        </button>
                        <button mat-flat-button color="primary" (click)="searchProducts()" [disabled]="loading">
                            <mat-icon>search</mat-icon> Buscar
                        </button>
                    </div>
                </div>
            </div>
        </mat-card-content>
    </mat-card>

    <!-- Tabla de Productos -->
    <mat-card class="table-card" *ngIf="products.length > 0 && !showPreview">
        <mat-card-header>
            <mat-card-title>Productos Encontrados ({{ products.length }})</mat-card-title>
            <mat-card-subtitle>{{ selection.selected.length }} producto(s) seleccionado(s)</mat-card-subtitle>
        </mat-card-header>
        <mat-card-content>
            <div class="table-container">
                <table mat-table [dataSource]="products" class="products-table">
                    <!-- Checkbox Column -->
                    <ng-container matColumnDef="select">
                        <th mat-header-cell *matHeaderCellDef>
                            <mat-checkbox (change)="$event ? toggleAllRows() : null"
                                [checked]="selection.hasValue() && isAllSelected()"
                                [indeterminate]="selection.hasValue() && !isAllSelected()"
                                [aria-label]="checkboxLabel()">
                            </mat-checkbox>
                        </th>
                        <td mat-cell *matCellDef="let row">
                            <mat-checkbox (click)="$event.stopPropagation()"
                                (change)="$event ? selection.toggle(row) : null" [checked]="selection.isSelected(row)"
                                [aria-label]="checkboxLabel(row)">
                            </mat-checkbox>
                        </td>
                    </ng-container>

                    <ng-container matColumnDef="name">
                        <th mat-header-cell *matHeaderCellDef>Nombre</th>
                        <td mat-cell *matCellDef="let product">{{ product.name }}</td>
                    </ng-container>

                    <ng-container matColumnDef="code">
                        <th mat-header-cell *matHeaderCellDef>Código</th>
                        <td mat-cell *matCellDef="let product">{{ product.code }}</td>
                    </ng-container>

                    <ng-container matColumnDef="reference">
                        <th mat-header-cell *matHeaderCellDef>Referencia</th>
                        <td mat-cell *matCellDef="let product">{{ product.reference }}</td>
                    </ng-container>

                    <ng-container matColumnDef="category">
                        <th mat-header-cell *matHeaderCellDef>Categoría</th>
                        <td mat-cell *matCellDef="let product">{{ product.category_name }}</td>
                    </ng-container>

                    <ng-container matColumnDef="pricebuy">
                        <th mat-header-cell *matHeaderCellDef>P. Compra</th>
                        <td mat-cell *matCellDef="let product">
                            {{ product.pricebuy | currency:'USD':'$':settingsService.getDecimalFormat('total') }}
                        </td>
                    </ng-container>

                    <ng-container matColumnDef="pricesell">
                        <th mat-header-cell *matHeaderCellDef>P. Venta</th>
                        <td mat-cell *matCellDef="let product">
                            {{ product.pricesell | currency:'USD':'$':settingsService.getDecimalFormat('total') }}
                        </td>
                    </ng-container>

                    <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
                    <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
                </table>
            </div>
        </mat-card-content>
    </mat-card>

    <!-- Configuración de Cambio -->
    <mat-card class="config-card" *ngIf="products.length > 0 && !showPreview">
        <mat-card-header>
            <mat-card-title>Configuración del Cambio</mat-card-title>
            <mat-card-subtitle>Define cómo se actualizarán los precios</mat-card-subtitle>
        </mat-card-header>
        <mat-card-content>
            <div class="config-grid">
                <mat-form-field appearance="outline">
                    <mat-label>Tipo de Cambio</mat-label>
                    <mat-select [(ngModel)]="changeType">
                        <mat-option value="percentage">Porcentaje (%)</mat-option>
                        <mat-option value="amount">Monto Fijo ($)</mat-option>
                    </mat-select>
                </mat-form-field>

                <mat-form-field appearance="outline">
                    <mat-label>Acción</mat-label>
                    <mat-select [(ngModel)]="changeAction">
                        <mat-option value="increase">Aumento (+)</mat-option>
                        <mat-option value="decrease">Disminución (-)</mat-option>
                    </mat-select>
                </mat-form-field>

                <mat-form-field appearance="outline">
                    <mat-label>Valor</mat-label>
                    <input matInput type="text" [(ngModel)]="changeValue" placeholder="0" appMoneyInput
                        decimalType="price">
                    <span matSuffix *ngIf="changeType === 'percentage'">%</span>
                    <span matPrefix *ngIf="changeType === 'amount'">$&nbsp;</span>
                </mat-form-field>
            </div>

            <div class="config-actions">
                <button mat-flat-button color="accent" (click)="generatePreview()"
                    [disabled]="loading || selection.selected.length === 0">
                    <mat-icon>preview</mat-icon> Generar Vista Previa
                </button>
            </div>
        </mat-card-content>
    </mat-card>

    <!-- Vista Previa -->
    <mat-card class="table-card" *ngIf="showPreview">
        <mat-card-header>
            <mat-card-title>Vista Previa de Cambios</mat-card-title>
            <mat-card-subtitle>Se actualizarán {{ previewProducts.length }} producto(s)</mat-card-subtitle>
        </mat-card-header>
        <mat-card-content>
            <div class="table-container">
                <table mat-table [dataSource]="previewProducts" class="preview-table">
                    <ng-container matColumnDef="name">
                        <th mat-header-cell *matHeaderCellDef>Producto</th>
                        <td mat-cell *matCellDef="let product">{{ product.name }}</td>
                    </ng-container>

                    <ng-container matColumnDef="code">
                        <th mat-header-cell *matHeaderCellDef>Código</th>
                        <td mat-cell *matCellDef="let product">{{ product.code }}</td>
                    </ng-container>

                    <ng-container matColumnDef="currentPrice">
                        <th mat-header-cell *matHeaderCellDef>Precio Actual</th>
                        <td mat-cell *matCellDef="let product">
                            {{ product.pricesell | currency:'USD':'$':settingsService.getDecimalFormat('total') }}
                        </td>
                    </ng-container>

                    <ng-container matColumnDef="newPrice">
                        <th mat-header-cell *matHeaderCellDef>Precio Nuevo</th>
                        <td mat-cell *matCellDef="let product" [class.price-increase]="product.difference > 0"
                            [class.price-decrease]="product.difference < 0">
                            {{ product.newPrice | currency:'USD':'$':settingsService.getDecimalFormat('total') }}
                        </td>
                    </ng-container>

                    <ng-container matColumnDef="difference">
                        <th mat-header-cell *matHeaderCellDef>Diferencia</th>
                        <td mat-cell *matCellDef="let product" [class.positive]="product.difference > 0"
                            [class.negative]="product.difference < 0">
                            {{ product.difference | currency:'USD':'$':settingsService.getDecimalFormat('total') }}
                        </td>
                    </ng-container>

                    <ng-container matColumnDef="percentage">
                        <th mat-header-cell *matHeaderCellDef>% Cambio</th>
                        <td mat-cell *matCellDef="let product" [class.positive]="product.percentageChange > 0"
                            [class.negative]="product.percentageChange < 0">
                            {{ product.percentageChange | number:'1.2-2' }}%
                        </td>
                    </ng-container>

                    <tr mat-header-row *matHeaderRowDef="previewColumns"></tr>
                    <tr mat-row *matRowDef="let row; columns: previewColumns;"></tr>
                </table>
            </div>

            <div class="preview-actions">
                <button mat-stroked-button (click)="showPreview = false">
                    <mat-icon>arrow_back</mat-icon> Volver
                </button>
                <button mat-flat-button color="primary" (click)="applyChanges()" [disabled]="loading">
                    <mat-icon>save</mat-icon> Aplicar Cambios
                </button>
            </div>
        </mat-card-content>
    </mat-card>

    <!-- Loading Spinner -->
    <div class="loading-container" *ngIf="loading">
        <mat-spinner diameter="40"></mat-spinner>
        <p>Procesando...</p>
    </div>

    <!-- Empty State -->
    <div class="empty-state" *ngIf="products.length === 0 && !loading">
        <mat-icon>search</mat-icon>
        <p>Aplique filtros y haga clic en "Buscar Productos" para comenzar</p>
    </div>
</div>