<div class="payment-container">
    <h2 mat-dialog-title>Abono de Deuda</h2>

    <div class="totals-summary" style="margin-bottom: 8px; padding: 6px;">
        <div class="total-item">
            <label style="font-size: 9px;">Deuda (USD)</label>
            <span style="font-size: 1rem;" class="value-usd">$ {{data.customer.curdebt | number:totalFormat}}</span>
        </div>
        <div class="total-item" *ngIf="data.exchangeRate">
            <label style="font-size: 9px;">Monto en Bs.</label>
            <span style="font-size: 1rem;" class="value-bs">{{(data.customer.curdebt * data.exchangeRate) |
                number:totalFormat}} Bs.</span>
        </div>
    </div>

    <div class="zen-details-container invoice-row-container" style="margin-bottom: 8px;">
        <div class="zen-detail-row">
            <label>Factura</label>
            <mat-select [(ngModel)]="selectedInvoice" (selectionChange)="onInvoiceChange($event.value)"
                class="zen-mat-select micro-detail-input" placeholder="Pulse para seleccionar factura...">
                <mat-option *ngFor="let inv of invoices" [value]="inv">
                    {{inv.dateInvoices}} - $ {{inv.balance | number:totalFormat}} ({{inv.numberInvoice}})
                </mat-option>
            </mat-select>
        </div>
    </div>

    <div class="currency-tabs" style="margin-bottom: 8px;">
        <div class="tab-btn" [class.active]="selectedCurrency === 'base'" (click)="setCurrency('base')">Bs.</div>
        <div class="tab-btn" [class.active]="selectedCurrency === 'alt'" (click)="setCurrency('alt')">$ USD</div>
    </div>

    <div class="zen-details-container" style="margin-bottom: 8px;">
        <div class="zen-detail-row">
            <label>Monto a Pagar</label>
            <input type="text" class="micro-detail-input" style="font-size: 1.05rem; font-weight: 700; color: #3f51b5;"
                *ngIf="selectedCurrency === 'base'" [(ngModel)]="amountBs" (ngModelChange)="onAmountBsChange($event)"
                appMoneyInput placeholder="0,00 Bs.">
            <input type="text" class="micro-detail-input" style="font-size: 1.05rem; font-weight: 700; color: #3f51b5;"
                *ngIf="selectedCurrency === 'alt'" [(ngModel)]="amountUsd" (ngModelChange)="onAmountUsdChange($event)"
                appMoneyInput placeholder="0,00 $">
        </div>

        <div class="exchange-rate-details" *ngIf="data.exchangeRate" style="padding: 4px 10px; margin-bottom: 4px;">
            <span class="equivalent-hint" *ngIf="selectedCurrency === 'base'">Recibe: <strong>$ {{amountUsd |
                    number:totalFormat}}</strong></span>
            <span class="equivalent-hint" *ngIf="selectedCurrency === 'alt'">Recibe: <strong>{{amountBs |
                    number:totalFormat}} Bs.</strong></span>
            <span class="rate-label">Tasa: <strong>{{data.exchangeRate | number:'1.2-2'}}</strong></span>
        </div>

        <div class="exchange-rate-details igtf-warning" *ngIf="igtfAmountAlt > 0"
            style="padding: 4px 10px; margin-bottom: 4px;">
            <span class="rate-label">IGTF ({{settingsService.getSettings()?.igtf_percentage}}%):
                <strong>$ {{igtfAmountAlt | number:totalFormat}}</strong> / {{igtfAmount | number:totalFormat}}
                Bs.</span>
        </div>

        <div class="zen-detail-row" *ngIf="paymentMethod === 'cash'">
            <label>Recibido</label>
            <input type="text" class="micro-detail-input" [(ngModel)]="amountReceived"
                (ngModelChange)="onAmountReceivedChange($event)" appMoneyInput placeholder="0,00">
        </div>

        <div class="zen-detail-row" *ngIf="change > 0 && paymentMethod === 'cash'">
            <label>Vuelto</label>
            <span class="micro-detail-input" style="color: #16a34a; font-weight: 700;">
                {{ change | number:totalFormat }} {{selectedCurrency === 'base' ? 'Bs.' : 'USD'}}
            </span>
        </div>
    </div>

    <div class="payment-methods" style="margin-bottom: 10px;">
        <div class="custom-method-btn" [class.active]="paymentMethod === 'cash'" (click)="setPaymentMethod('cash')">
            <mat-icon>payments</mat-icon>
            <span>Efectivo</span>
        </div>
        <div class="custom-method-btn" [class.active]="paymentMethod === 'card'" (click)="setPaymentMethod('card')">
            <mat-icon>credit_card</mat-icon>
            <span>Tarjeta</span>
        </div>
        <div class="custom-method-btn" [class.active]="paymentMethod === 'paper'" (click)="setPaymentMethod('paper')">
            <mat-icon>smartphone</mat-icon>
            <span>Pago Móvil</span>
        </div>
        <div class="custom-method-btn" [class.active]="paymentMethod === 'transfer'"
            (click)="setPaymentMethod('transfer')">
            <mat-icon>sync_alt</mat-icon>
            <span>Transf.</span>
        </div>
    </div>

    <div class="zen-details-container" *ngIf="paymentMethod !== 'cash'" style="margin-bottom: 6px;">
        <div class="zen-detail-row">
            <label>Referencia</label>
            <input type="text" class="micro-detail-input" [(ngModel)]="reference" placeholder="Ref #">
        </div>
        <div class="zen-detail-row">
            <label>Banco</label>
            <mat-select [(ngModel)]="selectedBankId" class="zen-mat-select micro-detail-input">
                <mat-option value="">Ninguno</mat-option>
                <mat-option *ngFor="let bank of getFilteredBanks()" [value]="bank.id">
                    {{ bank.name }} ({{ bank.currency }})
                </mat-option>
            </mat-select>
        </div>
        <div class="zen-detail-row" *ngIf="paymentMethod === 'paper'">
            <label>Cédula/ID</label>
            <input type="text" class="micro-detail-input" [(ngModel)]="cedula" placeholder="V-123...">
        </div>
        <div class="zen-detail-row" *ngIf="paymentMethod === 'transfer'">
            <label>Cta. Destino</label>
            <input type="text" class="micro-detail-input" [(ngModel)]="account" placeholder="Últimos 4...">
        </div>
    </div>

    <div class="actions">
        <button mat-button class="btn-cancel" (click)="onCancel()" [disabled]="isLoading">CANCELAR</button>
        <button mat-raised-button class="btn-confirm" [disabled]="!isValid() || isLoading" (click)="onConfirm()"
            [appLoading]="isLoading">
            CONFIRMAR ABONO
        </button>
    </div>
</div>