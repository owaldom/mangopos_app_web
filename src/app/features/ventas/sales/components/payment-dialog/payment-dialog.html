<div class="payment-container">
    <div class="scrollable-content">
        <h2 class="title">Finalizar Venta</h2>

        <div class="customer-credit-info" *ngIf="data.customer">
            <div class="customer-name">
                <mat-icon>person</mat-icon>
                <span>{{ data.customer.name }}</span>
            </div>
            <div class="credit-details">
                <div class="credit-stat">
                    <span class="label">Límite:</span>
                    <span class="value">{{ data.customer.maxdebt | currency:'USD':'$
                        ':settingsService.getDecimalFormat('total') }}</span>
                </div>
                <div class="credit-stat">
                    <span class="label">Deuda:</span>
                    <span class="value debt">{{ data.customer.curdebt || 0 | currency:'USD':'$
                        ':settingsService.getDecimalFormat('total') }}</span>
                </div>
                <div class="credit-stat">
                    <span class="label">Disponible:</span>
                    <span class="value available">{{ (data.customer.maxdebt - (data.customer.curdebt || 0)) |
                        currency:'USD':'$ ':settingsService.getDecimalFormat('total') }}</span>
                </div>
            </div>
        </div>

        <div class="totals-summary">
            <div class="total-row">
                <span>Subtotal</span>
                <span>{{ data.subtotal | currency:'VES':'Bs. ':settingsService.getDecimalFormat('total') }}</span>
            </div>
            <div class="total-row">
                <span>Impuestos</span>
                <span>{{ data.taxes | currency:'VES':'Bs. ':settingsService.getDecimalFormat('total') }}</span>
            </div>
            <div class="total-row igtf" *ngIf="igtfAmountAlt > 0">
                <span>I.G.T.F. ({{ settingsService.getSettings()?.igtf_percentage }}%)</span>
                <div style="text-align: right;">
                    <div style="font-size: 0.9rem; opacity: 0.8;">{{ igtfAmountAlt | currency:'USD':'$
                        ':settingsService.getDecimalFormat('total') }}</div>
                    <div>{{ igtfAmount | currency:'VES':'Bs. ':settingsService.getDecimalFormat('total') }}</div>
                </div>
            </div>
            <div class="total-row main">
                <span>TOTAL</span>
                <div style="text-align: right;">
                    <div style="font-size: 0.9rem; opacity: 0.8;">{{ data.totalAlt | currency:'USD':'$
                        ':settingsService.getDecimalFormat('total') }}</div>
                    <div>{{ data.total * data.exchangeRate | currency:'VES':'Bs.
                        ':settingsService.getDecimalFormat('total')
                        }}</div>
                </div>
            </div>
        </div>

        <div class="input-section">
            <div class="currency-tabs">
                <button [class.active]="selectedCurrency === 'base'" (click)="setCurrency('base')">Bs.</button>
                <button [class.active]="selectedCurrency === 'alt'" (click)="setCurrency('alt')">$ USD</button>
            </div>
            <div class="payment-mode-toggle" style="margin-top: 10px; text-align: center; margin-bottom: 1rem;">
                <button mat-stroked-button color="primary" (click)="toggleMultiPayment()">
                    <mat-icon>{{ isMultiPayment ? 'arrow_back' : 'layers' }}</mat-icon>
                    {{ isMultiPayment ? 'Volver a Pago Simple' : 'Activar Pago Mixto' }}
                </button>
            </div>

            <!-- Single Payment Mode -->
            <ng-container *ngIf="!isMultiPayment">
                <div *ngIf="selectedCurrency === 'base'" class="single-input-wrapper">
                    <mat-form-field appearance="outline" class="full-width">
                        <mat-label>Monto Recibido</mat-label>
                        <span matTextPrefix>Bs. &nbsp;</span>
                        <input matInput appMoneyInput [(ngModel)]="receivedAmount"
                            (ngModelChange)="calculateChange($event, 'base')" autocomplete="off">
                    </mat-form-field>
                </div>

                <div *ngIf="selectedCurrency === 'alt'" class="single-input-wrapper">
                    <mat-form-field appearance="outline" class="full-width">
                        <mat-label>Monto Recibido</mat-label>
                        <span matTextPrefix>$ &nbsp;</span>
                        <input matInput appMoneyInput [(ngModel)]="receivedAmountAlt"
                            (ngModelChange)="calculateChange($event, 'alt')" autocomplete="off">
                    </mat-form-field>
                </div>

                <!-- Extra Fields for Single Mode -->
                <div *ngIf="requiresBank(selectedMethod)"
                    style="margin-top: 8px; display: flex; flex-direction: column; gap: 8px;">

                    <!-- Pago Móvil Extra: Phone/ID -->
                    <mat-form-field appearance="outline" density="compact" *ngIf="selectedMethod === 'PagoMovil'"
                        style="width: 100%;">
                        <mat-label>Teléfono / Cédula</mat-label>
                        <input matInput [(ngModel)]="paymentDetails['PagoMovil'].cedula"
                            placeholder="0412... / V-1234...">
                    </mat-form-field>

                    <!-- Transfer Extra: Account Number -->
                    <mat-form-field appearance="outline" density="compact" *ngIf="selectedMethod === 'transfer'"
                        style="width: 100%;">
                        <mat-label>Número de Cuenta (Opcional)</mat-label>
                        <input matInput [(ngModel)]="paymentDetails['transfer'].account" placeholder="0102...">
                    </mat-form-field>

                    <div style="display: flex; gap: 8px;">
                        <mat-form-field appearance="outline" density="compact" style="flex: 1;">
                            <mat-label>Referencia</mat-label>
                            <input matInput [(ngModel)]="paymentDetails[selectedMethod].reference" placeholder="Ref #">
                        </mat-form-field>
                        <mat-form-field appearance="outline" density="compact" style="flex: 1;">
                            <mat-label>Banco</mat-label>
                            <mat-select [(ngModel)]="selectedBankId">
                                <mat-option value="">Ninguno</mat-option>
                                <mat-option *ngFor="let bank of getFilteredBanks(selectedMethod)" [value]="bank.id">
                                    {{ bank.name }} - {{ bank.account_type_name }} ({{ bank.currency }})
                                </mat-option>
                            </mat-select>
                        </mat-form-field>
                    </div>
                </div>
            </ng-container>

            <!-- Multi Payment Mode -->
            <div *ngIf="isMultiPayment" class="multi-payment-list">

                <!-- Cash -->
                <div class="multi-row-mat">
                    <div class="method-icon"><mat-icon title="Efectivo">payments</mat-icon></div>
                    <div class="method-name">Efectivo</div>
                    <mat-form-field appearance="outline" density="compact">
                        <span matTextPrefix>Bs. &nbsp;</span>
                        <input matInput appMoneyInput [(ngModel)]="payments['cash']"
                            (ngModelChange)="updateMultiPayment('cash', $event, 'base')" placeholder="0,00">
                    </mat-form-field>
                    <mat-form-field appearance="outline" density="compact">
                        <span matTextPrefix>$ &nbsp;</span>
                        <input matInput appMoneyInput [(ngModel)]="paymentsAlt['cash']"
                            (ngModelChange)="updateMultiPayment('cash', $event, 'alt')" placeholder="0.00">
                    </mat-form-field>
                    <!-- Placeholders to keep grid alignment -->
                    <div></div>
                    <div></div>
                    <div></div>
                </div>

                <!-- Card -->
                <div class="multi-row-mat">
                    <div class="method-icon"><mat-icon title="Tarjeta">credit_card</mat-icon></div>
                    <div class="method-name">Tarjeta</div>
                    <mat-form-field appearance="outline" density="compact">
                        <span matTextPrefix>Bs. &nbsp;</span>
                        <input matInput appMoneyInput [(ngModel)]="payments['card']"
                            (ngModelChange)="updateMultiPayment('card', $event, 'base')" placeholder="0,00">
                    </mat-form-field>
                    <mat-form-field appearance="outline" density="compact">
                        <span matTextPrefix>$ &nbsp;</span>
                        <input matInput appMoneyInput [(ngModel)]="paymentsAlt['card']"
                            (ngModelChange)="updateMultiPayment('card', $event, 'alt')" placeholder="0.00"
                            [disabled]="true">
                    </mat-form-field>
                    <mat-form-field appearance="outline" density="compact">
                        <mat-label>Referencia</mat-label>
                        <input matInput [(ngModel)]="paymentDetails['card'].reference" placeholder="Ref #">
                    </mat-form-field>
                    <mat-form-field appearance="outline" density="compact">
                        <mat-label>Banco</mat-label>
                        <mat-select [(ngModel)]="paymentDetails['card'].bank_id">
                            <mat-option value="">Ninguno</mat-option>
                            <mat-option *ngFor="let bank of getFilteredBanks('card')" [value]="bank.id">
                                {{ bank.name }} - {{ bank.account_type_name }} ({{ bank.currency }})
                            </mat-option>
                        </mat-select>
                    </mat-form-field>
                    <div></div> <!-- Spacer -->
                </div>

                <!-- Pago Móvil -->
                <div class="multi-row-mat">
                    <div class="method-icon"><mat-icon title="Pago Móvil">smartphone</mat-icon></div>
                    <div class="method-name">Pago Móvil</div>
                    <mat-form-field appearance="outline" density="compact">
                        <span matTextPrefix>Bs. &nbsp;</span>
                        <input matInput appMoneyInput [(ngModel)]="payments['PagoMovil']"
                            (ngModelChange)="updateMultiPayment('PagoMovil', $event, 'base')" placeholder="0,00">
                    </mat-form-field>
                    <mat-form-field appearance="outline" density="compact">
                        <span matTextPrefix>$ &nbsp;</span>
                        <input matInput appMoneyInput [(ngModel)]="paymentsAlt['PagoMovil']"
                            (ngModelChange)="updateMultiPayment('PagoMovil', $event, 'alt')" placeholder="0.00"
                            [disabled]="true">
                    </mat-form-field>
                    <mat-form-field appearance="outline" density="compact">
                        <mat-label>Referencia</mat-label>
                        <input matInput [(ngModel)]="paymentDetails['PagoMovil'].reference" placeholder="Ref #">
                    </mat-form-field>
                    <mat-form-field appearance="outline" density="compact">
                        <mat-label>Banco</mat-label>
                        <mat-select [(ngModel)]="paymentDetails['PagoMovil'].bank_id">
                            <mat-option value="">Ninguno</mat-option>
                            <mat-option *ngFor="let bank of getFilteredBanks('PagoMovil')" [value]="bank.id">
                                {{ bank.name }} - {{ bank.account_type_name }} ({{ bank.currency }})
                            </mat-option>
                        </mat-select>
                    </mat-form-field>
                    <mat-form-field appearance="outline" density="compact">
                        <mat-label>Tlf / Cédula</mat-label>
                        <input matInput [(ngModel)]="paymentDetails['PagoMovil'].cedula" placeholder="0412... / V-...">
                    </mat-form-field>
                </div>

                <!-- Transfer -->
                <div class="multi-row-mat">
                    <div class="method-icon"><mat-icon title="Transferencia">sync_alt</mat-icon></div>
                    <div class="method-name">Transferencia</div>
                    <mat-form-field appearance="outline" density="compact">
                        <span matTextPrefix>Bs. &nbsp;</span>
                        <input matInput appMoneyInput [(ngModel)]="payments['transfer']"
                            (ngModelChange)="updateMultiPayment('transfer', $event, 'base')" placeholder="0,00">
                    </mat-form-field>
                    <mat-form-field appearance="outline" density="compact">
                        <span matTextPrefix>$ &nbsp;</span>
                        <input matInput appMoneyInput [(ngModel)]="paymentsAlt['transfer']"
                            (ngModelChange)="updateMultiPayment('transfer', $event, 'alt')" placeholder="0.00"
                            [disabled]="true">
                    </mat-form-field>
                    <mat-form-field appearance="outline" density="compact">
                        <mat-label>Referencia</mat-label>
                        <input matInput [(ngModel)]="paymentDetails['transfer'].reference" placeholder="Ref #">
                    </mat-form-field>
                    <mat-form-field appearance="outline" density="compact">
                        <mat-label>Banco</mat-label>
                        <mat-select [(ngModel)]="paymentDetails['transfer'].bank_id">
                            <mat-option value="">Ninguno</mat-option>
                            <mat-option *ngFor="let bank of getFilteredBanks('transfer')" [value]="bank.id">
                                {{ bank.name }} - {{ bank.account_type_name }} ({{ bank.currency }})
                            </mat-option>
                        </mat-select>
                    </mat-form-field>
                    <mat-form-field appearance="outline" density="compact">
                        <mat-label>Cuenta</mat-label>
                        <input matInput [(ngModel)]="paymentDetails['transfer'].account" placeholder="0102...">
                    </mat-form-field>
                </div>

                <!-- Crédito (Deuda) -->
                <div class="multi-row-mat" *ngIf="data.customer">
                    <div class="method-icon"><mat-icon title="Venta a Crédito">request_quote</mat-icon></div>
                    <div class="method-name">Crédito</div>
                    <mat-form-field appearance="outline" density="compact">
                        <span matTextPrefix>Bs. &nbsp;</span>
                        <input matInput appMoneyInput [(ngModel)]="payments['Credito']"
                            (ngModelChange)="updateMultiPayment('Credito', $event, 'base')" placeholder="0,00">
                    </mat-form-field>
                    <mat-form-field appearance="outline" density="compact">
                        <span matTextPrefix>$ &nbsp;</span>
                        <input matInput appMoneyInput [(ngModel)]="paymentsAlt['Credito']"
                            (ngModelChange)="updateMultiPayment('Credito', $event, 'alt')" placeholder="0.00">
                    </mat-form-field>
                    <!-- Placeholders -->
                    <div></div>
                    <div></div>
                    <div></div>
                </div>

            </div>
        </div>

        <div class="change-display">
            <!-- Change Display (if overpaid) -->
            <span class="change-label" *ngIf="remaining <= 0">Cambio:</span>
            <div style="text-align: right;" *ngIf="remaining <= 0">
                <div style="font-size: 0.9rem; opacity: 0.8;">{{ changeAlt | currency:'USD':'$
                    ':settingsService.getDecimalFormat('total') }}</div>
                <div class="change-value">{{ change | currency:'VES':'Bs. ':settingsService.getDecimalFormat('total') }}
                </div>
            </div>

            <!-- Remaining Display (if underpaid) -->
            <span class="change-label" *ngIf="remaining > 0" style="color: #d32f2f;">Restante:</span>
            <div style="text-align: right;" *ngIf="remaining > 0">
                <div style="font-size: 0.9rem; opacity: 0.8; color: #d32f2f;">{{ remainingAlt | currency:'USD':'$
                    ':settingsService.getDecimalFormat('total') }}</div>
                <div class="change-value" style="color: #d32f2f;">{{ remaining | currency:'VES':'Bs.
                    ':settingsService.getDecimalFormat('total') }}
                </div>
            </div>
        </div>

    </div> <!-- End scrollable-content -->
    <div class="methods-grid" *ngIf="!isMultiPayment">
        <div class="method-btn" [class.active]="selectedMethod === 'cash'" (click)="selectedMethod = 'cash'">
            <mat-icon>payments</mat-icon>
            <span>Efectivo</span>
        </div>
        <div class="method-btn" [class.active]="selectedMethod === 'card'" [class.disabled]="isMethodDisabled('card')"
            (click)="!isMethodDisabled('card') && (selectedMethod = 'card')">
            <mat-icon>credit_card</mat-icon>
            <span>Tarjeta</span>
        </div>
        <div class="method-btn" [class.active]="selectedMethod === 'PagoMovil'"
            [class.disabled]="isMethodDisabled('PagoMovil')"
            (click)="!isMethodDisabled('PagoMovil') && (selectedMethod = 'PagoMovil')">
            <mat-icon>smartphone</mat-icon>
            <span>Pago Móvil</span>
        </div>
        <div class="method-btn" [class.active]="selectedMethod === 'transfer'"
            [class.disabled]="isMethodDisabled('transfer')"
            (click)="!isMethodDisabled('transfer') && (selectedMethod = 'transfer')">
            <mat-icon>sync_alt</mat-icon>
            <span>Transferencia</span>
        </div>
        <div class="method-btn" [class.active]="selectedMethod === 'Credito'"
            [class.disabled]="isMethodDisabled('Credito')"
            (click)="!isMethodDisabled('Credito') && (selectedMethod = 'Credito')">
            <mat-icon>request_quote</mat-icon>
            <span>Crédito</span>
        </div>
    </div>

    <div class="actions">
        <button mat-stroked-button class="btn-cancel" (click)="onCancel()">CANCELAR</button>
        <button mat-raised-button class="btn-confirm" (click)="onConfirm()" [disabled]="remaining > 0.01">
            CONFIRMAR PAGO
        </button>
    </div>
</div>