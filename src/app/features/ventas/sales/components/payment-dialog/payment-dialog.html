<div class="payment-container">
    <div class="scrollable-content">
        <h2 class="title">Finalizar Venta</h2>

        <div class="customer-credit-info" *ngIf="data.customer">
            <div class="customer-name">
                <mat-icon>person</mat-icon>
                <span>{{ data.customer.name }}</span>
            </div>
            <div class="credit-details">
                <div class="credit-stat">
                    <span class="label">Límite:</span>
                    <span class="value">{{ data.customer.maxdebt | currency:'USD':'$
                        ':settingsService.getDecimalFormat('total') }}</span>
                </div>
                <div class="credit-stat">
                    <span class="label">Deuda:</span>
                    <span class="value debt">{{ data.customer.curdebt || 0 | currency:'USD':'$
                        ':settingsService.getDecimalFormat('total') }}</span>
                </div>
                <div class="credit-stat">
                    <span class="label">Disponible:</span>
                    <span class="value available">{{ (data.customer.maxdebt - (data.customer.curdebt || 0)) |
                        currency:'USD':'$ ':settingsService.getDecimalFormat('total') }}</span>
                </div>
            </div>
        </div>

        <div class="totals-summary">
            <div class="total-row">
                <span>Subtotal</span>
                <span>{{ data.subtotal | currency:'VES':'Bs. ':settingsService.getDecimalFormat('total') }}</span>
            </div>
            <div class="total-row">
                <span>IVA ({{ getTaxPercentage() }}%)</span>
                <span>{{ data.taxes | currency:'VES':'Bs. ':settingsService.getDecimalFormat('total') }}</span>
            </div>
            <div class="total-row igtf"
                *ngIf="settingsService.getSettings()?.igtf_enabled && (selectedCurrency === 'alt' || isMultiPayment)">
                <span>I.G.T.F. ({{ settingsService.getSettings()?.igtf_percentage || 3 }}%)</span>
                <div style="text-align: right;">
                    <div style="font-size: 0.9rem; opacity: 0.8;">{{ igtfAmountAlt | currency:'USD':'$
                        ':settingsService.getDecimalFormat('total') }}</div>
                    <div>{{ igtfAmount | currency:'VES':'Bs. ':settingsService.getDecimalFormat('total') }}</div>
                </div>
            </div>
            <div class="total-row main">
                <span>TOTAL</span>
                <div style="text-align: right;">
                    <div style="font-size: 0.9rem; opacity: 0.8;">{{ data.totalAlt | currency:'USD':'$
                        ':settingsService.getDecimalFormat('total') }}</div>
                    <div>{{ data.total * data.exchangeRate | currency:'VES':'Bs.
                        ':settingsService.getDecimalFormat('total')
                        }}</div>
                </div>
            </div>
        </div>

        <div class="input-section">
            <div class="currency-tabs">
                <button [class.active]="selectedCurrency === 'base'" (click)="setCurrency('base')">Bs.</button>
                <button [class.active]="selectedCurrency === 'alt'" (click)="setCurrency('alt')">$ USD</button>
            </div>
            <div class="payment-mode-toggle" style="margin-top: 6px; text-align: center; margin-bottom: 0.5rem;">
                <button mat-stroked-button color="primary" (click)="toggleMultiPayment()">
                    <mat-icon>{{ isMultiPayment ? 'arrow_back' : 'layers' }}</mat-icon>
                    {{ isMultiPayment ? 'Volver a Pago Simple' : 'Activar Pago Mixto' }}
                </button>
            </div>

            <!-- Single Payment Mode -->
            <ng-container *ngIf="!isMultiPayment">
                <div *ngIf="selectedCurrency === 'base'" class="single-input-wrapper" style="margin-top: 4px;">
                    <mat-form-field appearance="outline" class="full-width" density="compact">
                        <mat-label>Monto Recibido</mat-label>
                        <span matTextPrefix style="font-size: 0.85rem;">Bs. &nbsp;</span>
                        <input matInput appMoneyInput [(ngModel)]="receivedAmount"
                            (ngModelChange)="calculateChange($event, 'base')" autocomplete="off"
                            style="font-size: 1.15rem; height: 28px; font-weight: 700;">
                    </mat-form-field>
                </div>

                <div *ngIf="selectedCurrency === 'alt'" class="single-input-wrapper" style="margin-top: 4px;">
                    <mat-form-field appearance="outline" class="full-width" density="compact">
                        <mat-label>Monto Recibido</mat-label>
                        <span matTextPrefix style="font-size: 0.85rem;">$ &nbsp;</span>
                        <input matInput appMoneyInput [(ngModel)]="receivedAmountAlt"
                            (ngModelChange)="calculateChange($event, 'alt')" autocomplete="off"
                            style="font-size: 1.15rem; height: 28px; font-weight: 700;">
                    </mat-form-field>
                </div>

                <!-- Single Payment Details - Zen Style (V17) -->
                <div class="zen-details-container" *ngIf="requiresBank(selectedMethod)">
                    <div class="zen-detail-row">
                        <!-- Reference -->
                        <div class="micro-detail-input">
                            <span class="label">Ref.</span>
                            <input type="text" [(ngModel)]="paymentDetails[selectedMethod].reference"
                                placeholder="Ref #">
                        </div>

                        <!-- Bank -->
                        <div class="micro-detail-input">
                            <span class="label">Banco</span>
                            <mat-select class="zen-mat-select" [(ngModel)]="selectedBankId" placeholder="Banco...">
                                <mat-option [value]="undefined">Ninguno</mat-option>
                                <mat-option *ngFor="let bank of getBankList(selectedMethod)" [value]="bank.id">
                                    {{ bank.name }}
                                </mat-option>
                            </mat-select>
                        </div>
                    </div>

                    <div class="zen-detail-row" *ngIf="selectedMethod === 'PagoMovil' || selectedMethod === 'transfer'">
                        <!-- Phone/ID for PM -->
                        <div class="micro-detail-input" *ngIf="selectedMethod === 'PagoMovil'">
                            <span class="label">Tlf/CI</span>
                            <input type="text" [(ngModel)]="paymentDetails['PagoMovil'].cedula"
                                placeholder="0412... / V-...">
                        </div>

                        <!-- Account for Transfer -->
                        <div class="micro-detail-input" *ngIf="selectedMethod === 'transfer'">
                            <span class="label">Cta.</span>
                            <input type="text" [(ngModel)]="paymentDetails['transfer'].account" placeholder="0102...">
                        </div>
                    </div>
                </div>
            </ng-container>

            <!-- Multi Payment Mode - Zen Mixed Pro (V16) -->
            <div *ngIf="isMultiPayment" class="multi-payment-grid">

                <!-- Cash Card -->
                <div class="payment-card cash" [class.active]="payments['cash'] > 0 || paymentsAlt['cash'] > 0">
                    <div class="card-header">
                        <mat-icon>payments</mat-icon>
                        <span class="card-name">Efectivo</span>
                    </div>
                    <div class="card-inputs">
                        <div class="micro-input-group">
                            <span class="prefix">Bs.</span>
                            <input type="text" appMoneyInput [(ngModel)]="payments['cash']"
                                (ngModelChange)="updateMultiPayment('cash', $event, 'base')" placeholder="0,00">
                        </div>
                        <div class="micro-input-group">
                            <span class="prefix">$</span>
                            <input type="text" appMoneyInput [(ngModel)]="paymentsAlt['cash']"
                                (ngModelChange)="updateMultiPayment('cash', $event, 'alt')" placeholder="0.00">
                        </div>
                    </div>
                </div>

                <!-- Card Card -->
                <div class="payment-card card" [class.active]="payments['card'] > 0">
                    <div class="card-header">
                        <mat-icon>credit_card</mat-icon>
                        <span class="card-name">Tarjeta</span>
                    </div>
                    <div class="card-inputs">
                        <div class="micro-input-group">
                            <span class="prefix">Bs.</span>
                            <input type="text" appMoneyInput [(ngModel)]="payments['card']"
                                (ngModelChange)="updateMultiPayment('card', $event, 'base')" placeholder="0,00">
                        </div>
                        <div class="details-toggle" *ngIf="payments['card'] > 0">
                            <input type="text" [(ngModel)]="paymentDetails['card'].reference" placeholder="Ref #">
                            <mat-select class="zen-mat-select" [(ngModel)]="paymentDetails['card'].bank_id"
                                placeholder="Banco...">
                                <mat-option [value]="undefined">Banco...</mat-option>
                                <mat-option *ngFor="let bank of getBankList('card')" [value]="bank.id">{{ bank.name }}
                                </mat-option>
                            </mat-select>
                        </div>
                    </div>
                </div>

                <!-- Pago Móvil Card -->
                <div class="payment-card pm" [class.active]="payments['PagoMovil'] > 0">
                    <div class="card-header">
                        <mat-icon>smartphone</mat-icon>
                        <span class="card-name">Pago Móvil</span>
                    </div>
                    <div class="card-inputs">
                        <div class="micro-input-group">
                            <span class="prefix">Bs.</span>
                            <input type="text" appMoneyInput [(ngModel)]="payments['PagoMovil']"
                                (ngModelChange)="updateMultiPayment('PagoMovil', $event, 'base')" placeholder="0,00">
                        </div>
                        <div class="details-toggle full" *ngIf="payments['PagoMovil'] > 0">
                            <input type="text" [(ngModel)]="paymentDetails['PagoMovil'].reference" placeholder="Ref #">
                            <mat-select class="zen-mat-select" [(ngModel)]="paymentDetails['PagoMovil'].bank_id"
                                placeholder="Banco...">
                                <mat-option [value]="undefined">Banco...</mat-option>
                                <mat-option *ngFor="let bank of getBankList('PagoMovil')" [value]="bank.id">{{
                                    bank.name }}</mat-option>
                            </mat-select>
                            <input type="text" [(ngModel)]="paymentDetails['PagoMovil'].cedula"
                                placeholder="Tlf/Cédula">
                        </div>
                    </div>
                </div>

                <!-- Transfer Card -->
                <div class="payment-card transfer" [class.active]="payments['transfer'] > 0">
                    <div class="card-header">
                        <mat-icon>sync_alt</mat-icon>
                        <span class="card-name">Transferencia</span>
                    </div>
                    <div class="card-inputs">
                        <div class="micro-input-group">
                            <span class="prefix">Bs.</span>
                            <input type="text" appMoneyInput [(ngModel)]="payments['transfer']"
                                (ngModelChange)="updateMultiPayment('transfer', $event, 'base')" placeholder="0,00">
                        </div>
                        <div class="details-toggle full" *ngIf="payments['transfer'] > 0">
                            <input type="text" [(ngModel)]="paymentDetails['transfer'].reference" placeholder="Ref #">
                            <mat-select class="zen-mat-select" [(ngModel)]="paymentDetails['transfer'].bank_id"
                                placeholder="Banco...">
                                <mat-option [value]="undefined">Banco...</mat-option>
                                <mat-option *ngFor="let bank of getBankList('transfer')" [value]="bank.id">
                                    {{ bank.name }}
                                </mat-option>
                            </mat-select>
                            <input type="text" [(ngModel)]="paymentDetails['transfer'].account" placeholder="Cuenta #">
                        </div>
                    </div>
                </div>

                <!-- Credit Card -->
                <div class="payment-card credit" *ngIf="data.customer"
                    [class.active]="payments['Credito'] > 0 || paymentsAlt['Credito'] > 0">
                    <div class="card-header">
                        <mat-icon>request_quote</mat-icon>
                        <span class="card-name">Crédito</span>
                    </div>
                    <div class="card-inputs">
                        <div class="micro-input-group">
                            <span class="prefix">Bs.</span>
                            <input type="text" appMoneyInput [(ngModel)]="payments['Credito']"
                                (ngModelChange)="updateMultiPayment('Credito', $event, 'base')" placeholder="0,00">
                        </div>
                        <div class="micro-input-group">
                            <span class="prefix">$</span>
                            <input type="text" appMoneyInput [(ngModel)]="paymentsAlt['Credito']"
                                (ngModelChange)="updateMultiPayment('Credito', $event, 'alt')" placeholder="0.00">
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="change-display">
            <!-- Change Display (if overpaid) -->
            <span class="change-label" *ngIf="remaining <= 0">Cambio:</span>
            <div style="text-align: right;" *ngIf="remaining <= 0">
                <div style="font-size: 0.9rem; opacity: 0.8;">{{ changeAlt | currency:'USD':'$
                    ':settingsService.getDecimalFormat('total') }}</div>
                <div class="change-value">{{ change | currency:'VES':'Bs. ':settingsService.getDecimalFormat('total') }}
                </div>
            </div>

            <!-- Remaining Display (if underpaid) -->
            <span class="change-label" *ngIf="remaining > 0" style="color: #d32f2f;">Restante:</span>
            <div style="text-align: right;" *ngIf="remaining > 0">
                <div style="font-size: 0.9rem; opacity: 0.8; color: #d32f2f;">{{ remainingAlt | currency:'USD':'$
                    ':settingsService.getDecimalFormat('total') }}</div>
                <div class="change-value" style="color: #d32f2f;">{{ remaining | currency:'VES':'Bs.
                    ':settingsService.getDecimalFormat('total') }}
                </div>
            </div>
        </div>

    </div> <!-- End scrollable-content -->
    <div class="methods-grid" *ngIf="!isMultiPayment">
        <div class="method-btn" [class.active]="selectedMethod === 'cash'" (click)="selectedMethod = 'cash'">
            <mat-icon>payments</mat-icon>
            <span>Efectivo</span>
        </div>
        <div class="method-btn" [class.active]="selectedMethod === 'card'" [class.disabled]="isMethodDisabled('card')"
            (click)="!isMethodDisabled('card') && (selectedMethod = 'card')">
            <mat-icon>credit_card</mat-icon>
            <span>Tarjeta</span>
        </div>
        <div class="method-btn" [class.active]="selectedMethod === 'PagoMovil'"
            [class.disabled]="isMethodDisabled('PagoMovil')"
            (click)="!isMethodDisabled('PagoMovil') && (selectedMethod = 'PagoMovil')">
            <mat-icon>smartphone</mat-icon>
            <span>Pago Móvil</span>
        </div>
        <div class="method-btn" [class.active]="selectedMethod === 'transfer'"
            [class.disabled]="isMethodDisabled('transfer')"
            (click)="!isMethodDisabled('transfer') && (selectedMethod = 'transfer')">
            <mat-icon>sync_alt</mat-icon>
            <span>Transferencia</span>
        </div>
        <div class="method-btn" [class.active]="selectedMethod === 'Credito'"
            [class.disabled]="isMethodDisabled('Credito')"
            (click)="!isMethodDisabled('Credito') && (selectedMethod = 'Credito')">
            <mat-icon>request_quote</mat-icon>
            <span>Crédito</span>
        </div>
    </div>

    <div class="actions">
        <button mat-stroked-button class="btn-cancel" (click)="onCancel()">CANCELAR</button>
        <button mat-raised-button class="btn-confirm" (click)="onConfirm()" [disabled]="remaining > 0.01">
            CONFIRMAR PAGO
        </button>
    </div>
</div>